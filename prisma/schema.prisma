generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id               String              @id @default(uuid())
  email            String              @unique
  phone            String
  name             String
  cpfCnpj          String              @unique
  password         String
  profileImage     String?
  userType         String
  isActive         Boolean             @default(true)
  isApproved       Boolean             @default(false)
  deactivatedAt    DateTime?
  termsAcceptedAt  DateTime?
  termsVersion     String?
  gender           String?
  maritalStatus    String?
  dateOfBirth      DateTime?
  description      String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  address          Address?
  clientProfile    ClientProfile?
  favorites        Favorite[]
  notifications    Notification[]
  payments         Payment[]
  receivedReviews  Review[]            @relation("ReviewReceiver")
  givenReviews     Review[]            @relation("ReviewGiver")
  serviceProvider  ServiceProvider?
  receivedRequests ServiceRequest[]    @relation("ProviderRequests")
  sentRequests     ServiceRequest[]    @relation("ClientRequests")
  adminAssignments SupportAssignment[]
  supportChats     SupportChat[]
  sentMessages     SupportMessage[]
  couponRedemptions CouponRedemption[]
   moderationsAsTarget UserModeration[] @relation("UserModerationsAsTarget")
  moderationsAsAdmin  UserModeration[] @relation("UserModerationsAsAdmin")

  @@map("users")
}

model ServiceProvider {
  id                 String                   @id @default(uuid())
  userId             String                   @unique
  hasScheduling      Boolean                  @default(false)
  hasQuoting         Boolean                  @default(true)
  chargesTravel      Boolean                  @default(false)
  travelCost         Float?
  travelRatePerKm    Float?
  travelMinimumFee   Float?
  serviceRadiusKm    Float?
  waivesTravelOnHire Boolean                  @default(false)
  isHighlighted      Boolean                  @default(false)
  highlightUntil     DateTime?
  // Habilitações/documentos (para serviços que exijam CNH, por exemplo)
  hasDriverLicense   Boolean                  @default(false)
  driverLicenseNumber String?
  driverLicenseCategory String?
  driverLicenseExpiresAt DateTime?
  planId             String?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  availability       Availability[]
  favoritedBy        Favorite[]
  services           ServiceProviderService[]
  user               User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activePlan         Plan?                    @relation(fields: [planId], references: [id])
  subscriptions      Subscription[]

  @@map("service_providers")
}

model ClientProfile {
  id          String             @id @default(uuid())
  userId      String             @unique
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  preferences ClientPreferences?
  privacy     ClientPrivacy?
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("client_profiles")
}

model ClientPreferences {
  id                    String        @id @default(uuid())
  clientProfileId       String        @unique
  emailNotifications    Boolean       @default(false)
  smsNotifications      Boolean       @default(false)
  whatsappNotifications Boolean       @default(false)
  marketingEmails       Boolean       @default(false)
  serviceReminders      Boolean       @default(false)
  reviewRequests        Boolean       @default(false)
  clientProfile         ClientProfile @relation(fields: [clientProfileId], references: [id], onDelete: Cascade)

  @@map("client_preferences")
}

model ClientPrivacy {
  id                String        @id @default(uuid())
  clientProfileId   String        @unique
  profileVisibility String        @default("PUBLIC")
  showPhone         Boolean       @default(false)
  showEmail         Boolean       @default(false)
  showLocation      Boolean       @default(false)
  clientProfile     ClientProfile @relation(fields: [clientProfileId], references: [id], onDelete: Cascade)

  @@map("client_privacy")
}

model Address {
  id         String   @id @default(uuid())
  userId     String   @unique
  state      String
  city       String
  district   String
  street     String
  number     String
  zipCode    String
  latitude   Float?
  longitude  Float?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  complement String?
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

model ServiceCategory {
  id           String            @id @default(uuid())
  name         String            @unique
  description  String?
  icon         String?
  isActive     Boolean           @default(true)
  parentId     String?
  level        Int               @default(0)
  isLeaf       Boolean           @default(false)
  displayOrder Int               @default(0)
  requiresDriverLicense Boolean  @default(false)
  allowScheduling      Boolean   @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  parent       ServiceCategory?  @relation("CategoryToParent", fields: [parentId], references: [id])
  children     ServiceCategory[] @relation("CategoryToParent")
  services     Service?

  @@map("service_categories")
}

model Service {
  id          String                   @id @default(uuid())
  name        String
  description String?
  categoryId  String                   @unique
  isActive    Boolean                  @default(true)
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
  providers   ServiceProviderService[]
  requests    ServiceRequest[]
  category    ServiceCategory          @relation(fields: [categoryId], references: [id])

  @@map("services")
}

model ServiceProviderService {
  id                String          @id @default(uuid())
  serviceProviderId String
  serviceId         String
  basePrice         Float?
  unit              String
  description       String?
  isActive          Boolean         @default(true)
  offersScheduling  Boolean         @default(false)
  providesHomeService Boolean       @default(false)
  providesLocalService Boolean      @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  service           Service         @relation(fields: [serviceId], references: [id])
  serviceProvider   ServiceProvider @relation(fields: [serviceProviderId], references: [id], onDelete: Cascade)

  @@unique([serviceProviderId, serviceId])
  @@map("service_provider_services")
}

model ServiceRequest {
  id             String    @id @default(uuid())
  clientId       String
  providerId     String
  serviceId      String
  requestType    String
  scheduledDate  DateTime?
  scheduledTime  String?
  description    String?
  status         String    @default("PENDING")
  estimatedPrice Float?
  finalPrice     Float?
  travelCost     Float?
  basePriceSnapshot        Float?
  travelDistanceKm         Float?
  travelDurationMinutes    Float?
  travelRatePerKmSnapshot  Float?
  travelMinimumFeeSnapshot Float?
  travelFixedFeeSnapshot   Float?
  schedulingFee  Float?
  isVisitVirtual Boolean   @default(false)
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  payments       Payment[]
  review         Review?
  providerReviewRating     Int?
  providerReviewComment    String?
  providerReviewGivenAt    DateTime?
  service        Service   @relation(fields: [serviceId], references: [id])
  provider       User      @relation("ProviderRequests", fields: [providerId], references: [id])
  client         User      @relation("ClientRequests", fields: [clientId], references: [id])

  @@map("service_requests")
}

model Availability {
  id                String          @id @default(uuid())
  serviceProviderId String
  dayOfWeek         Int
  startTime         String
  endTime           String
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  serviceProvider   ServiceProvider @relation(fields: [serviceProviderId], references: [id], onDelete: Cascade)

  @@map("availability")
}

model Payment {
  id               String          @id @default(uuid())
  userId           String
  serviceRequestId String?
  subscriptionId   String?
  amount           Float
  currency         String          @default("BRL")
  paymentMethod    String
  gateway          String
  gatewayPaymentId String?         @unique
  status           String          @default("PENDING")
  description      String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  subscription     Subscription?   @relation(fields: [subscriptionId], references: [id])
  serviceRequest   ServiceRequest? @relation(fields: [serviceRequestId], references: [id])
  user             User            @relation(fields: [userId], references: [id])
  couponRedemption CouponRedemption?

  @@map("payments")
}

model Plan {
  id               String            @id @default(uuid())
  name             String            @unique
  description      String?
  price            Float
  billingCycle     String
  features         String
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  serviceProviders ServiceProvider[]
  subscriptions    Subscription[]
  couponRedemptions CouponRedemption[]

  @@map("plans")
}

model Subscription {
  id                String          @id @default(uuid())
  serviceProviderId String
  planId            String
  status            String          @default("ACTIVE")
  startDate         DateTime
  endDate           DateTime?
  isAutoRenew       Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  payments          Payment[]
  plan              Plan            @relation(fields: [planId], references: [id])
  serviceProvider   ServiceProvider @relation(fields: [serviceProviderId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Review {
  id               String         @id @default(uuid())
  serviceRequestId String         @unique
  giverId          String
  receiverId       String
  rating           Int
  comment          String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  receiver         User           @relation("ReviewReceiver", fields: [receiverId], references: [id])
  giver            User           @relation("ReviewGiver", fields: [giverId], references: [id])
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id])

  @@map("reviews")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  isRead    Boolean  @default(false)
  data      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sentVia   String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model SystemSettings {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model SupportedRegion {
  id        String   @id @default(uuid())
  state     String
  city      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([state, city])
  @@map("supported_regions")
}

model Favorite {
  id                String          @id @default(uuid())
  userId            String
  serviceProviderId String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  serviceProvider   ServiceProvider @relation(fields: [serviceProviderId], references: [id], onDelete: Cascade)
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, serviceProviderId])
  @@map("favorites")
}

model SupportChat {
  id          String              @id @default(cuid())
  userId      String
  status      String              @default("OPEN")
  priority    String              @default("MEDIUM")
  subject     String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  closedAt    DateTime?
  closedBy    String?
  assignments SupportAssignment[]
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages    SupportMessage[]

  @@map("support_chats")
}

model SupportMessage {
  id          String      @id @default(cuid())
  chatId      String
  senderId    String
  content     String
  type        String      @default("TEXT")
  isFromAdmin Boolean     @default(false)
  readAt      DateTime?
  createdAt   DateTime    @default(now())
  sender      User        @relation(fields: [senderId], references: [id])
  chat        SupportChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@map("support_messages")
}

model SupportAssignment {
  id         String      @id @default(cuid())
  chatId     String
  adminId    String
  assignedAt DateTime    @default(now())
  isActive   Boolean     @default(true)
  admin      User        @relation(fields: [adminId], references: [id])
  chat       SupportChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@map("support_assignments")
}

model UserModeration {
  id        String   @id @default(uuid())
  userId    String
  adminId   String?                       // deixe opcional p/ permitir SetNull
  action    String                        // "DEACTIVATE" | "ACTIVATE" | "APPROVE" | "REJECT"
  reason    String?
  createdAt DateTime @default(now())

  // dê nomes diferentes às 2 relações para User:
  user  User  @relation("UserModerationsAsTarget", fields: [userId], references: [id], onDelete: Cascade)
  admin User? @relation("UserModerationsAsAdmin",  fields: [adminId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([adminId, createdAt])
  @@map("user_moderation")
}

model Coupon {
  id              String   @id @default(uuid())
  code            String   @unique
  discountType    String   // PERCENT | FIXED
  value           Float
  appliesTo       String   // FREE | PREMIUM | ANY
  validFrom       DateTime?
  validTo         DateTime?
  maxRedemptions  Int?
  perUserLimit    Int?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  redemptions     CouponRedemption[]

  @@map("coupons")
}

model PendingProviderRegistration {
  id                     String   @id @default(uuid())
  name                   String
  email                  String
  phone                  String
  cpfCnpj                String
  passwordHash           String
  userType               String
  personType             String
  plan                   String
  gender                 String?
  maritalStatus          String?
  dateOfBirth            DateTime?
  hasDriverLicense       Boolean  @default(false)
  driverLicenseNumber    String?
  driverLicenseCategory  String?
  driverLicenseExpiresAt DateTime?
  extraData              Json?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("pending_provider_registrations")
  @@index([email])
  @@index([cpfCnpj])
}

model CouponRedemption {
  id        String   @id @default(uuid())
  couponId  String
  userId    String
  planId    String?
  amountOff Float?
  paymentId String?  @unique
  createdAt DateTime @default(now())

  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])
  plan   Plan?  @relation(fields: [planId], references: [id])
  payment Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@map("coupon_redemptions")
}
